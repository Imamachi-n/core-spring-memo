<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Spring Conteiner, Dependency Injection | Core Spring Memo</title>
    <meta name="description" content="Spring Framework 5.x / Spring Boot 2.x">
    <link rel="icon" href="/core-spring-memo/hero.jpg">
  <link rel="manifest" href="/core-spring-memo/manifest.json">
    
    <link rel="preload" href="/core-spring-memo/assets/css/0.styles.32f8bd5f.css" as="style"><link rel="preload" href="/core-spring-memo/assets/js/app.9b30392b.js" as="script"><link rel="preload" href="/core-spring-memo/assets/js/5.805898ac.js" as="script"><link rel="prefetch" href="/core-spring-memo/assets/js/2.a9af1da4.js"><link rel="prefetch" href="/core-spring-memo/assets/js/3.f2366002.js"><link rel="prefetch" href="/core-spring-memo/assets/js/4.bd0f5c6c.js"><link rel="prefetch" href="/core-spring-memo/assets/js/6.3b75b1fa.js"><link rel="prefetch" href="/core-spring-memo/assets/js/7.7434e2ac.js"><link rel="prefetch" href="/core-spring-memo/assets/js/8.56422d25.js"><link rel="prefetch" href="/core-spring-memo/assets/js/9.3ce6252a.js"><link rel="prefetch" href="/core-spring-memo/assets/js/10.eef91609.js"><link rel="prefetch" href="/core-spring-memo/assets/js/11.b0e9e856.js"><link rel="prefetch" href="/core-spring-memo/assets/js/12.b2e1cd91.js"><link rel="prefetch" href="/core-spring-memo/assets/js/13.58c56373.js"><link rel="prefetch" href="/core-spring-memo/assets/js/14.1e8ab758.js">
    <link rel="stylesheet" href="/core-spring-memo/assets/css/0.styles.32f8bd5f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/core-spring-memo/" class="home-link router-link-active"><!----><span class="site-name">
      Core Spring Memo
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/core-spring-memo/" class="nav-link">Home</a></div><div class="nav-item"><a href="/core-spring-memo/about/" class="nav-link">このページについて</a></div><div class="nav-item"><a href="/core-spring-memo/contents/" class="nav-link router-link-active">Springメモ</a></div><div class="nav-item"><a href="/core-spring-memo/handson/" class="nav-link">ハンズオン</a></div><a href="https://github.com/Imamachi-n/core-spring-memo" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/core-spring-memo/" class="nav-link">Home</a></div><div class="nav-item"><a href="/core-spring-memo/about/" class="nav-link">このページについて</a></div><div class="nav-item"><a href="/core-spring-memo/contents/" class="nav-link router-link-active">Springメモ</a></div><div class="nav-item"><a href="/core-spring-memo/handson/" class="nav-link">ハンズオン</a></div><a href="https://github.com/Imamachi-n/core-spring-memo" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav><ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>Contents</span><!----></p><ul class="sidebar-group-items"><li><a href="/core-spring-memo/contents/" class="sidebar-link">はじめに</a></li><li><a href="/core-spring-memo/contents/1_di.html" class="active sidebar-link">Spring Conteiner, Dependency Injection</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/core-spring-memo/contents/1_di.html#dependency-injectionとその利点" class="sidebar-link">Dependency Injectionとその利点</a></li><li class="sidebar-sub-header"><a href="/core-spring-memo/contents/1_di.html#パターン・アンチパターンとは。diとはパターンなのか？" class="sidebar-link">パターン・アンチパターンとは。DIとはパターンなのか？</a></li><li class="sidebar-sub-header"><a href="/core-spring-memo/contents/1_di.html#インターフェイスとその利点" class="sidebar-link">インターフェイスとその利点</a></li><li class="sidebar-sub-header"><a href="/core-spring-memo/contents/1_di.html#spring-beansでインターフェイスの利用が推奨される理由" class="sidebar-link">Spring beansでインターフェイスの利用が推奨される理由</a></li><li class="sidebar-sub-header"><a href="/core-spring-memo/contents/1_di.html#application-contextとはspringが管理するコンテナのこと" class="sidebar-link">application-contextとはSpringが管理するコンテナのこと</a></li><li class="sidebar-sub-header"><a href="/core-spring-memo/contents/1_di.html#複数ファイルからapplicationcontextを作成する" class="sidebar-link">複数ファイルからApplicationContextを作成する</a></li><li class="sidebar-sub-header"><a href="/core-spring-memo/contents/1_di.html#beanのスコープ" class="sidebar-link">Beanのスコープ</a></li><li class="sidebar-sub-header"><a href="/core-spring-memo/contents/1_di.html#環境設定（environmentオブジェクトとして読み込み）の読み込み" class="sidebar-link">環境設定（Environmentオブジェクトとして読み込み）の読み込み</a></li><li class="sidebar-sub-header"><a href="/core-spring-memo/contents/1_di.html#環境変数（プロパティ）にアクセスする" class="sidebar-link">環境変数（プロパティ）にアクセスする</a></li><li class="sidebar-sub-header"><a href="/core-spring-memo/contents/1_di.html#開発系・テスト系・本番系で環境変数（プロパティ）を変更する" class="sidebar-link">開発系・テスト系・本番系で環境変数（プロパティ）を変更する</a></li><li class="sidebar-sub-header"><a href="/core-spring-memo/contents/1_di.html#プロファイルを用いてbeanをグループ化" class="sidebar-link">プロファイルを用いてBeanをグループ化</a></li><li class="sidebar-sub-header"><a href="/core-spring-memo/contents/1_di.html#プロファイルを有効化する方法" class="sidebar-link">プロファイルを有効化する方法</a></li><li class="sidebar-sub-header"><a href="/core-spring-memo/contents/1_di.html#プロパティファイルの選択（開発系・本番系）" class="sidebar-link">プロパティファイルの選択（開発系・本番系）</a></li><li class="sidebar-sub-header"><a href="/core-spring-memo/contents/1_di.html#wip-積み残し課題" class="sidebar-link">[WIP] 積み残し課題</a></li></ul></li><li><a href="/core-spring-memo/contents/2_aop.html" class="sidebar-link">Aspect oriented programming</a></li><li><a href="/core-spring-memo/contents/3_data-management.html" class="sidebar-link">JDBC, Transactions, JPA, Spring Data</a></li><li><a href="/core-spring-memo/contents/4_spring-boot.html" class="sidebar-link">Spring Boot</a></li><li><a href="/core-spring-memo/contents/5_mvc.html" class="sidebar-link">Spring MVC and the Web Layer</a></li><li><a href="/core-spring-memo/contents/6_security.html" class="sidebar-link">Security</a></li><li><a href="/core-spring-memo/contents/7_rest.html" class="sidebar-link">REST</a></li><li><a href="/core-spring-memo/contents/8_testing.html" class="sidebar-link">Testing</a></li></ul></div></li></ul></div><div class="page"><div class="content"><h1 id="spring-conteiner-dependency-injection"><a href="#spring-conteiner-dependency-injection" aria-hidden="true" class="header-anchor">#</a> Spring Conteiner, Dependency Injection</h1><h2 id="dependency-injectionとその利点"><a href="#dependency-injectionとその利点" aria-hidden="true" class="header-anchor">#</a> Dependency Injectionとその利点</h2><p>Dependency Injection (DI)は「依存性の注入」と訳される。<br>
必要なインスタンス（依存性）を<strong>外から代入</strong>することで、各モジュールが疎結合になるように設計する。<br>
硬い言葉で表現すると、あるオブジェクトに対して、利用（依存）しているオブジェクトを注入することで、オブジェクト間の依存関係を作成する。</p><p><img src="/core-spring-memo/assets/img/C001_DI.83f1d512.png" alt="C001_DI"></p><p>DIを行うメリットとしては、</p><ul><li>クラス間・Layer間を疎結合化できる。</li><li>Unitテストがしやすくなる（Testabilityの向上）</li><li>インスタンスの差し替えなどが可能となる（例えば、テスト時に開発系・テスト系・本番系のデータアクセスクラスを用意してDIしたり）。</li></ul><p>などが挙げられる。</p><h3 id="spring-frameworkにおけるdiの方法"><a href="#spring-frameworkにおけるdiの方法" aria-hidden="true" class="header-anchor">#</a> Spring FrameworkにおけるDIの方法</h3><ol><li>Javaコンフィグファイル</li><li>アノテーション</li><li>XML (→古いのでほとんど使われない)</li></ol><div class="danger custom-block"><p class="custom-block-title">注意</p><p>XMLによる設定はすでにレガシーなので、原則的には使わないようにしましょう。</p></div><h3 id="参考"><a href="#参考" aria-hidden="true" class="header-anchor">#</a> 参考</h3><p><a href="https://www.slideshare.net/masatoshitada7/30spring-5-spring-boot-2-103523666" target="_blank" rel="noopener noreferrer">初めてでも30分で分かるSpring 5 &amp; Spring Boot 2オーバービュー<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><h2 id="パターン・アンチパターンとは。diとはパターンなのか？"><a href="#パターン・アンチパターンとは。diとはパターンなのか？" aria-hidden="true" class="header-anchor">#</a> パターン・アンチパターンとは。DIとはパターンなのか？</h2><p>アンチパターンとは、推奨されない設計のことを指す。<br>
DIも設計パターンの一部と言える。</p><p>従来型のクラス設計（Servlet、ビジネスロジック、DAO、DTO）は、お互いが密結合になりがち。
結果として、改修を重ねるごとに改修の難易度が増す（ビジネスロジックの複雑化・肥大化が原因の1つ）。</p><p>DIを利用したクラス設計を行うことで、上記の各クラスが疎結合化し、関心事の分離が可能となる。
結果として、コードがスッキリする。</p><h2 id="インターフェイスとその利点"><a href="#インターフェイスとその利点" aria-hidden="true" class="header-anchor">#</a> インターフェイスとその利点</h2><p>DIを行う上で、インターフェイスの用意は必須と言える。</p><p>（DIの利点ではないが）インターフェイスを用意することで、ポリモーフィズムの活用などでメリットが生まれる。</p><h3 id="_1-jdk-proxy"><a href="#_1-jdk-proxy" aria-hidden="true" class="header-anchor">#</a> 1. JDK Proxy</h3><p>インターフェイスを実装したクラスにインジェクション（Spring FrameworkだとこちらがDefault。インターフェイス持たないクラスの場合、CGlib Proxyに処理を委譲する仕組みになっている）<br>
当たり前だが、インターフェイスを持たないクラスをProxy化することはできない。</p><h3 id="_2-cglib-proxy"><a href="#_2-cglib-proxy" aria-hidden="true" class="header-anchor">#</a> 2. CGlib Proxy</h3><p>スーパークラスを継承したクラスにインジェクション（Spring BootだとこちらがDefault）<br>
スーパークラス側で<code>final</code>のついたクラス・メソッドは継承・オーバーライドができないため、それらのクラスはProxy化することができない。</p><h2 id="spring-beansでインターフェイスの利用が推奨される理由"><a href="#spring-beansでインターフェイスの利用が推奨される理由" aria-hidden="true" class="header-anchor">#</a> Spring beansでインターフェイスの利用が推奨される理由</h2><p>Spring FrameworkではJDK Proxyがデフォルトとなっており、JDK ProxyによるProxy生成の前提条件として、インターフェースの実装があるため。</p><h2 id="application-contextとはspringが管理するコンテナのこと"><a href="#application-contextとはspringが管理するコンテナのこと" aria-hidden="true" class="header-anchor">#</a> application-contextとはSpringが管理するコンテナのこと</h2><p>SpringのConfigurationクラスやApplicationクラスをインスタンス化する（これらインスタンスのことをBeanと呼ぶ）と、SpringのコンテナであるApplicationContext下で管理される。</p><p><img src="/core-spring-memo/assets/img/C009_1_DI.e036f09e.png" alt="C009_1_DI.png"></p><p>Applicationクラスの例。</p><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransferServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">TransferService</span> <span class="token punctuation">{</span>
    <span class="token comment">// Needed to perform moneytransfers between accounts</span>
    <span class="token keyword">public</span> <span class="token function">TransferServiceImpl</span><span class="token punctuation">(</span>AccountRepository ar<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>accountRepository <span class="token operator">=</span> ar<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JdbcAccountRepository</span> <span class="token keyword">implements</span> <span class="token class-name">AccountRepository</span> <span class="token punctuation">{</span>
    <span class="token comment">// Needed to load accounts from the database</span>
    <span class="token keyword">public</span> <span class="token function">JdbcAccountRepository</span><span class="token punctuation">(</span>DataSource ds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>dataSource <span class="token operator">=</span> ds<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Configurationクラス（Configuration Instructions）の例。</p><div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationConfig</span><span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> TransferService <span class="token function">transferService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TransferServiceImpl</span><span class="token punctuation">(</span><span class="token function">accountRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> AccountRepository <span class="token function">accountRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JdbcAccountRepository</span><span class="token punctuation">(</span><span class="token function">dataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> DataSource <span class="token function">dataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        BasicDataSource dataSource <span class="token operator">=</span> New <span class="token class-name">BasicDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataSource<span class="token punctuation">.</span><span class="token function">setDriverClassName</span><span class="token punctuation">(</span><span class="token string">&quot;org.postgresql.Driver&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataSource<span class="token punctuation">.</span><span class="token function">setUrl</span><span class="token punctuation">(</span><span class="token string">&quot;jdbc:postgresql://localhost/transfer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataSource<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataSource<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">&quot;password&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> dataSource<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>実行クラスの例。</p><div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// Create the application from the configuration</span>
ApplicationContext context <span class="token operator">=</span> 
    SpringApplication<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span> ApplicationConfig<span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Look up the application service interface</span>
<span class="token comment">// &quot;transferService&quot;がBean IDとなる。</span>
TransferService service <span class="token operator">=</span> 
    context<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>“transferService”<span class="token punctuation">,</span> TransferService<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Use the application</span>
service<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MonetaryAmount</span><span class="token punctuation">(</span>“<span class="token number">300.00</span>”<span class="token punctuation">)</span><span class="token punctuation">,</span> “<span class="token number">1</span>”<span class="token punctuation">,</span> “<span class="token number">2</span>”<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>BeanへのアクセスはBean IDがユニークである場合に限り、以下のようにBean IDを省略できる（基本的に、Bean IDはユニークであるように設計するため、以下の書き方が一般的）。</p><div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// No need for bean id if type is unique</span>
TransferService ts3 <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>TransferService<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="junitのテストクラス作成（diしない場合の例）"><a href="#junitのテストクラス作成（diしない場合の例）" aria-hidden="true" class="header-anchor">#</a> JUnitのテストクラス作成（DIしない場合の例）</h3><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransferServiceTests</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> TransferService service<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@BeforeEach</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Create the application from the configuration</span>
        ApplicationContext context <span class="token operator">=</span>
            SpringApplication<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span> ApplicationConfig<span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Look up the application service interface</span>
        service <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>TransferService<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Test</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">moneyTransfer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Confirmation receipt <span class="token operator">=</span>
            service<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MonetaryAmount</span><span class="token punctuation">(</span><span class="token string">&quot;300.00&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        Assert<span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">&quot;500.00&quot;</span><span class="token punctuation">,</span> receipt<span class="token punctuation">.</span><span class="token function">getNewBalance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="複数ファイルからapplicationcontextを作成する"><a href="#複数ファイルからapplicationcontextを作成する" aria-hidden="true" class="header-anchor">#</a> 複数ファイルからApplicationContextを作成する</h2><p><code>@Configuration</code>アノテーションを付けたクラスは長くなりがちなので、分割しておくことができる。</p><p>特定のConfigクラスを読み込むには、<code>@Import</code>アノテーションをつけて、読み込むクラス名を指定する。</p><p>大元のConfigクラス。<code>ApplicationConfig</code>クラスと<code>WebConfig</code>クラスをインポートしている。</p><div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span><span class="token punctuation">{</span>ApplicationConfig<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> WebConfig<span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InfrastructureConfig</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>インポートされるConfigクラスたち。</p><div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationConfig</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebConfig</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>Application</code> Beansと<code>Infrastructure</code> Beansを分離しておくのがBest Practices。</p><p><img src="/core-spring-memo/assets/img/C010_1_DI.1a08c3c9.png" alt="C010_1_DI.png"></p><p>以下に２つに分割する前の例を示す。</p><div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationConfig</span><span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> TransferService <span class="token function">transferService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TransferServiceImpl</span><span class="token punctuation">(</span><span class="token function">accountRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> AccountRepository <span class="token function">accountRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JdbcAccountRepository</span><span class="token punctuation">(</span><span class="token function">dataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> DataSource <span class="token function">dataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        BasicDataSource dataSource <span class="token operator">=</span> New <span class="token class-name">BasicDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataSource<span class="token punctuation">.</span><span class="token function">setDriverClassName</span><span class="token punctuation">(</span><span class="token string">&quot;org.postgresql.Driver&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataSource<span class="token punctuation">.</span><span class="token function">setUrl</span><span class="token punctuation">(</span><span class="token string">&quot;jdbc:postgresql://localhost/transfer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataSource<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataSource<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">&quot;password&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> dataSource<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>以下に分割後の例を示す。<br><code>ApplicationConfig</code>クラス内のBeanは、インポート先の<code>TestInfrastructureConfig</code>クラスのDataSourceのBeanに依存している。</p><p>DataSourceのBeanを使うために、<code>@Autowired</code>アノテーションを使って、別のconfigクラスのBeanを取得する（これをインジェクションという）。コンストラクタでインジェクションするのが普通。</p><p>ただし、configクラス内でコンストラクタが１つの場合、<code>@Autowired</code>アノテーションを省略することができる。</p><div class="language-java extra-class"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationConfig</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> DataSource dataSource<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">public</span> <span class="token function">ApplicationConfig</span><span class="token punctuation">(</span>DataSource ds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>dataSource <span class="token operator">=</span> ds<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span> 
    <span class="token keyword">public</span> TransferService <span class="token function">transferService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TransferServiceImpl</span> <span class="token punctuation">(</span> <span class="token function">accountRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span> 
    <span class="token keyword">public</span> AccountRepository <span class="token function">accountRepository</span><span class="token punctuation">(</span>DataSource dataSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JdbcAccountRepository</span><span class="token punctuation">(</span> dataSource <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><div class="highlight-lines"><br><div class="highlighted"> </div><br><br><br><br><br><br><br></div><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span>ApplicationConfig<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestInfrastructureConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span> 
    <span class="token keyword">public</span> DataSource <span class="token function">dataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="beanのスコープ"><a href="#beanのスコープ" aria-hidden="true" class="header-anchor">#</a> Beanのスコープ</h2><h3 id="singletonスコープ"><a href="#singletonスコープ" aria-hidden="true" class="header-anchor">#</a> Singletonスコープ</h3><p>デフォルトのスコープは<code>singleton</code>。</p><div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token annotation punctuation">@Scope</span><span class="token punctuation">(</span>“singleton”<span class="token punctuation">)</span>
<span class="token keyword">public</span> AccountService <span class="token function">accountService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>インスタンスが作られるのは１回きり。２回目は同じインスタンスが使い回される。</p><div class="language-java extra-class"><pre class="language-java"><code>AccountService service1 <span class="token operator">=</span> <span class="token punctuation">(</span>AccountService<span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>“accountService”<span class="token punctuation">)</span><span class="token punctuation">;</span>
AccountService service2 <span class="token operator">=</span> <span class="token punctuation">(</span>AccountService<span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>“accountService”<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">assert</span> service1 <span class="token operator">==</span> service2<span class="token punctuation">;</span> <span class="token comment">// True – same object</span>
</code></pre></div><ul><li>Springアプリケーションは複数リクエストに対して、マルチスレッドで処理。</li><li>スレッドセーフでなければならない（Stateless・Immutable beans）。</li></ul><h3 id="protptypeスコープ"><a href="#protptypeスコープ" aria-hidden="true" class="header-anchor">#</a> Protptypeスコープ</h3><div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token annotation punctuation">@Scope</span><span class="token punctuation">(</span>“prototype”<span class="token punctuation">)</span>
<span class="token keyword">public</span> AccountService <span class="token function">accountService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> …
<span class="token punctuation">}</span>
</code></pre></div><p>毎回新しいインスタンスが生成される。</p><div class="language-java extra-class"><pre class="language-java"><code>AccountService service1 <span class="token operator">=</span> <span class="token punctuation">(</span>AccountService<span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>“accountService”<span class="token punctuation">)</span><span class="token punctuation">;</span>
AccountService service2 <span class="token operator">=</span> <span class="token punctuation">(</span>AccountService<span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>“accountService”<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">assert</span> service1 <span class="token operator">!=</span> service2<span class="token punctuation">;</span> <span class="token comment">// True – different objects</span>
</code></pre></div><h3 id="spring側で用意されているスコープ"><a href="#spring側で用意されているスコープ" aria-hidden="true" class="header-anchor">#</a> Spring側で用意されているスコープ</h3><table><thead><tr><th>スコープ名</th><th>説明</th></tr></thead><tbody><tr><td>singleton</td><td>１つのインスタンスが作られる</td></tr><tr><td>prototype</td><td>新しいインスタンスが毎回作られる</td></tr><tr><td>session</td><td>新しいインスタンスがユーザごとに１つ作られる</td></tr><tr><td>request</td><td>新しいインスタンスがリクエストごとに１つ作られる</td></tr></tbody></table><p>ほとんどの場合は、singleton。sessionを時々使う。他のスコープはまず使わない。</p><p>prototypeの場合、Springのコンテナ管理外となる。その場合、生成されたBeanはJavaのガベージコレクション（GA）の対象となり、普通のJavaのインスタンスとして扱われる。</p><h2 id="環境設定（environmentオブジェクトとして読み込み）の読み込み"><a href="#環境設定（environmentオブジェクトとして読み込み）の読み込み" aria-hidden="true" class="header-anchor">#</a> 環境設定（Environmentオブジェクトとして読み込み）の読み込み</h2><p>以下の順番で、環境設定を読み込む（外から変えられるものから読み込まれる）。</p><ol><li>Servlet Contextパラメータ（web.xml）</li><li>JNDI (Java Naming and Directory Interface)</li><li>JVMシステムプロパティ（java -Dxxx=yyy）</li><li>OS環境変数（Cloudでよく使う）</li><li>Javaプロパティファイル</li></ol><h3 id="環境変数の読み込み例"><a href="#環境変数の読み込み例" aria-hidden="true" class="header-anchor">#</a> 環境変数の読み込み例</h3><p>環境設定（app.properties）から取得した値を変数に格納して、引数として取る。</p><div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DbConfig</span> <span class="token punctuation">{</span>
    
    Environment env<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">public</span> <span class="token function">DbConfig</span><span class="token punctuation">(</span>Environment env<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>env <span class="token operator">=</span> env<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> DataSource <span class="token function">dataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        BasicDataSource ds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BasicDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ds<span class="token punctuation">.</span><span class="token function">setDriverClassName</span><span class="token punctuation">(</span> env<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span> <span class="token string">&quot;db.driver&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ds<span class="token punctuation">.</span><span class="token function">setUrl</span><span class="token punctuation">(</span> env<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span> <span class="token string">&quot;db.url&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ds<span class="token punctuation">.</span><span class="token function">setUser</span><span class="token punctuation">(</span> env<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span> <span class="token string">&quot;db.user&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ds<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span> env<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span> <span class="token string">&quot;db.password&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ds<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>app.properties</p><div class="language- extra-class"><pre class="language-text"><code>db.driver=org.postgresql.Driver
db.url=jdbc:postgresql:localhost/transfer
db.user=transfer-app
db.password=secret45
</code></pre></div><p>Javaプロパティファイルを読み込むには、<code>@PropertySource</code>アノテーションを用いてファイルパスを指定する。</p><div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@PropertySource</span> <span class="token punctuation">(</span> <span class="token string">&quot;classpath:/com/organization/config/app.properties&quot;</span> <span class="token punctuation">)</span>
<span class="token annotation punctuation">@PropertySource</span> <span class="token punctuation">(</span> <span class="token string">&quot;file:config/local.properties&quot;</span> <span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationConfig</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="環境変数（プロパティ）にアクセスする"><a href="#環境変数（プロパティ）にアクセスする" aria-hidden="true" class="header-anchor">#</a> 環境変数（プロパティ）にアクセスする</h2><p><code>@Value</code>アノテーションを用いて、引数に値を代入することで、プロパティにアクセスすることもできる。Environmentオブジェクトをわざわざ用意する必要がなくなる。</p><div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DbConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> DataSource <span class="token function">dataSource</span><span class="token punctuation">(</span>
            <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${db.driver}&quot;</span><span class="token punctuation">)</span> String driver<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${db.url}&quot;</span><span class="token punctuation">)</span> String url<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${db.user}&quot;</span><span class="token punctuation">)</span> String user<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${db.password}&quot;</span><span class="token punctuation">)</span> String pwd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        BasicDataSource ds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BasicDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ds<span class="token punctuation">.</span><span class="token function">setDriverClassName</span><span class="token punctuation">(</span>driver<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ds<span class="token punctuation">.</span><span class="token function">setUrl</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ds<span class="token punctuation">.</span><span class="token function">setUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ds<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span>pwd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ds<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="開発系・テスト系・本番系で環境変数（プロパティ）を変更する"><a href="#開発系・テスト系・本番系で環境変数（プロパティ）を変更する" aria-hidden="true" class="header-anchor">#</a> 開発系・テスト系・本番系で環境変数（プロパティ）を変更する</h2><p><code>${ENV}</code>を変数にして、複数のプロパティファイルに対応できる。</p><div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@PropertySource</span> <span class="token punctuation">(</span> <span class="token string">&quot;classpath:/com/acme/config/app-${ENV}.properties&quot;</span> <span class="token punctuation">)</span>
</code></pre></div><p>開発系<code>app-dev.properties</code></p><div class="language- extra-class"><pre class="language-text"><code>db.driver=org.postgresql.Driver
db.url=jdbc:postgresql://localhost/transfer
db.user=transfer-app
db.password=secret45
</code></pre></div><p>テスト系<code>app-qa.properties</code></p><div class="language- extra-class"><pre class="language-text"><code>db.driver=org.postgresql.Driver
db.url=jdbc:postgresql://qa/transfer
db.user=transfer-app
db.password=secret88
</code></pre></div><p>本番系<code>app-prod.properties</code></p><div class="language- extra-class"><pre class="language-text"><code>db.driver=org.postgresql.Driver
db.url=jdbc:postgresql://prod/transfer
db.user=transfer-app
db.password=secret99
</code></pre></div><h2 id="プロファイルを用いてbeanをグループ化"><a href="#プロファイルを用いてbeanをグループ化" aria-hidden="true" class="header-anchor">#</a> プロファイルを用いてBeanをグループ化</h2><p>Beanをプロファイルでグループ化することができる。<br>
グループに属していないBeanは<strong>いつでも</strong>使われる。</p><p><img src="/core-spring-memo/assets/img/C011_1_DI.d91cfbdf.png" alt="C011_1_DI.png"></p><p><code>@Profile</code>でJava configクラスがどのグループに属するか決められる（メソッド単位で付けられる）。</p><div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@Profile</span><span class="token punctuation">(</span><span class="token string">&quot;dev&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DevConfig</span> <span class="token punctuation">{</span>
<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> DataSource <span class="token function">dataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    EmbeddedDatabaseBuilder builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EmbeddedDatabaseBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;testdb&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span>EmbeddedDatabaseType<span class="token punctuation">.</span>HSQL<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">addScript</span><span class="token punctuation">(</span><span class="token string">&quot;classpath:/testdb/schema.db&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">addScript</span><span class="token punctuation">(</span><span class="token string">&quot;classpath:/testdb/test-data.db&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>開発用と本番用で同じBean ID名・異なるメソッド名を付けて、<code>@Profile</code>アノテーションで開発用と本番用を使い分ける。</p><div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataSourceConfig</span> <span class="token punctuation">{</span>
    <span class="token comment">// 開発用</span>
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;dataSource&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Profile</span><span class="token punctuation">(</span><span class="token string">&quot;dev&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> DataSource <span class="token function">dataSourceForDev</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        EmbeddedDatabaseBuilder builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EmbeddedDatabaseBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;testdb&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 本番用</span>
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;dataSource&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Profile</span><span class="token punctuation">(</span><span class="token string">&quot;prod&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> DataSource <span class="token function">dataSourceForProd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        BasicDataSource dataSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BasicDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> dataSource<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><h3 id="特定のプロファイル（グループ）から除外する"><a href="#特定のプロファイル（グループ）から除外する" aria-hidden="true" class="header-anchor">#</a> 特定のプロファイル（グループ）から除外する</h3><p><code>!</code>を付けてプロファイルを指定することで、そのプロファイルから除外することができる。以下の例では、<code>dev</code>以外でBeanが使われる。</p><div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@Profile</span><span class="token punctuation">(</span><span class="token string">&quot;!dev&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DevConfig</span> <span class="token punctuation">{</span>
    …
<span class="token punctuation">}</span>
</code></pre></div><h2 id="プロファイルを有効化する方法"><a href="#プロファイルを有効化する方法" aria-hidden="true" class="header-anchor">#</a> プロファイルを有効化する方法</h2><h3 id="jvmシステムプロパティ"><a href="#jvmシステムプロパティ" aria-hidden="true" class="header-anchor">#</a> JVMシステムプロパティ</h3><div class="language- extra-class"><pre class="language-text"><code>-Dspring.profiles.active=dev,jpa
</code></pre></div><h3 id="java-config"><a href="#java-config" aria-hidden="true" class="header-anchor">#</a> Java config</h3><div class="language-java extra-class"><pre class="language-java"><code>System<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;spring.profiles.active&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;dev,jpa&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
SpringApplication<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>AppConfig<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="テスト時"><a href="#テスト時" aria-hidden="true" class="header-anchor">#</a> テスト時</h3><p><code>@ActiveProfiles</code>アノテーションを使う。</p><h2 id="プロパティファイルの選択（開発系・本番系）"><a href="#プロパティファイルの選択（開発系・本番系）" aria-hidden="true" class="header-anchor">#</a> プロパティファイルの選択（開発系・本番系）</h2><h3 id="開発系"><a href="#開発系" aria-hidden="true" class="header-anchor">#</a> 開発系</h3><p>開発用のプロパティファイル<code>dev.properties</code>を読み込む。<br>
プロファイルは<code>dev</code>を使う。</p><div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@Profile</span><span class="token punctuation">(</span>“dev”<span class="token punctuation">)</span>
<span class="token annotation punctuation">@PropertySource</span> <span class="token punctuation">(</span> “dev<span class="token punctuation">.</span>properties” <span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">DevConfig</span> <span class="token punctuation">{</span> … <span class="token punctuation">}</span>
</code></pre></div><h3 id="本番系"><a href="#本番系" aria-hidden="true" class="header-anchor">#</a> 本番系</h3><p>開発用のプロパティファイル<code>prod.properties</code>を読み込む。<br>
プロファイルは<code>prod</code>を使う。</p><div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@Profile</span><span class="token punctuation">(</span>“prod”<span class="token punctuation">)</span>
<span class="token annotation punctuation">@PropertySource</span> <span class="token punctuation">(</span> “prod<span class="token punctuation">.</span>properties” <span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">ProdConfig</span> <span class="token punctuation">{</span> … <span class="token punctuation">}</span>
</code></pre></div><h2 id="wip-積み残し課題"><a href="#wip-積み残し課題" aria-hidden="true" class="header-anchor">#</a> [WIP] 積み残し課題</h2><ul><li>What is the concept of a “container” and what is its lifecycle?</li><li>How are you going to create a new instance of an ApplicationContext?</li><li>Can you describe the lifecycle of a Spring Bean in an ApplicationContext?</li><li>How are you going to create an ApplicationContext in an integration test test?</li><li>What is the preferred way to close an application context? Does Spring Boot do this for you?</li><li>Dependency injection using annotations (@Component, @Autowired)?</li><li>Component scanning, Stereotypes and Meta-Annotations?</li><li>Are beans lazily or eagerly instantiated by default? How do you alter this behavior?</li><li>What is a BeanFactoryPostProcessor and what is it used for? When is it invoked?</li><li>Why would you define a static @Bean method?</li><li>What is a ProperySourcesPlaceholderConfigurer used for?</li><li>What is a BeanPostProcessor and how is it different to a BeanFactoryPostProcessor?</li><li>What do they do? When are they called?</li><li>What is an initialization method and how is it declared on a Spring bean?</li><li>What is a destroy method, how is it declared and when is it called?</li><li>Consider how you enable JSR-250 annotations like @PostConstruct and @PreDestroy? When/how will they get called?</li><li>How else can you define an initialization or destruction method for a Spring bean?</li><li>What does component-scanning do?</li><li>What is the behavior of the annotation @Autowired with regards to field injection, constructor injection and method injection?</li><li>What do you have to do, if you would like to inject something into a private field? Ho does this impact testing?</li><li>How does the @Qualifier annotation complement the use of @Autowired?</li><li>What is a proxy object and what are the two different types of proxies Spring can create?</li><li>What are the limitations of these proxies (per type)?</li><li>What is the power of a proxy object and where are the disadvantages?</li><li>What are the advantages of Java Config? What are the limitations?</li><li>What does the @Bean annotation do?</li><li>What is the default bean id if you only use @Bean? How can you override this?</li><li>Why are you not allowed to annotate a final class with @Configuration</li><li>How do @Configuration annotated classes support singleton beans?</li><li>Why can’t @Bean methods be final either?</li><li>How do you configure profiles?, What are possible use cases where they might be useful?</li><li>Can you use @Bean together with @Profile?</li><li>Can you use @Component together with @Profile?</li><li>How many profiles can you have?</li><li>How do you inject scalar/literal values into Spring beans?</li><li>What is @Value used for?</li><li>What is Spring Expression Language (SpEL for short)?</li><li>What is the Environment abstraction in Spring?</li><li>Where can properties in the environment come from – there are many sources for properties – check the documentation if not sure. Spring Boot adds even more.</li><li>What can you reference using SpEL?</li><li>What is the difference between $ and # in @Value expressions?</li></ul></div><div class="page-edit"><div class="edit-link"><a href="https://github.com/Imamachi-n/core-spring-memo/edit/master/docs/contents/1_di.md" target="_blank" rel="noopener noreferrer">Edit this page on GitHub</a><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div><div class="last-updated"><span class="prefix">Last Updated: </span><span class="time">7/23/2018, 10:48:40 PM</span></div></div><div class="page-nav"><p class="inner"><span class="prev">
        ← <a href="/core-spring-memo/contents/" class="prev router-link-active">
          はじめに
        </a></span><span class="next"><a href="/core-spring-memo/contents/2_aop.html">
          Aspect oriented programming
        </a> →
      </span></p></div></div></div></div>
    <script src="/core-spring-memo/assets/js/5.805898ac.js" defer></script><script src="/core-spring-memo/assets/js/app.9b30392b.js" defer></script>
  </body>
</html>
