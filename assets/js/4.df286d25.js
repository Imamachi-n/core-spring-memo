(window.webpackJsonp=window.webpackJsonp||[]).push([[4],{153:function(t,a,s){t.exports=s.p+"assets/img/C006_6_Spring_Security.722185e9.png"},154:function(t,a,s){t.exports=s.p+"assets/img/C007_6_Spring_Security.92fb7bbb.png"},155:function(t,a,s){t.exports=s.p+"assets/img/C008_6_Spring_Security.80e72137.png"},161:function(t,a,s){"use strict";s.r(a);var n=[function(){var t=this,a=t.$createElement,n=t._self._c||a;return n("div",{staticClass:"content"},[n("h1",{attrs:{id:"security"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#security","aria-hidden":"true"}},[t._v("#")]),t._v(" Security")]),t._v(" "),n("h2",{attrs:{id:"セキュリティ用語"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#セキュリティ用語","aria-hidden":"true"}},[t._v("#")]),t._v(" セキュリティ用語")]),t._v(" "),n("ul",[n("li",[t._v("Principal: システムを扱う人・機械のこと")]),t._v(" "),n("li",[t._v("Authentication(認証): ID・パスワードが有効かどうか確認すること（ログイン）")]),t._v(" "),n("li",[t._v("Authorization(認可): アクセス権のこと。")]),t._v(" "),n("li",[t._v("Authority(権限): 管理者権限・ユーザ権限とか。（Roleともいう）")]),t._v(" "),n("li",[t._v("Secured Item: セキュリティで保護されている対象。")])]),t._v(" "),n("h2",{attrs:{id:"認証と認可"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#認証と認可","aria-hidden":"true"}},[t._v("#")]),t._v(" 認証と認可")]),t._v(" "),n("p",[t._v("認証が先で、認可が後から付与されるもの。")]),t._v(" "),n("h3",{attrs:{id:"認証"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#認証","aria-hidden":"true"}},[t._v("#")]),t._v(" 認証")]),t._v(" "),n("ul",[n("li",[t._v("BASIC認証")]),t._v(" "),n("li",[t._v("OAuth認証")])]),t._v(" "),n("p",[t._v("などなど。")]),t._v(" "),n("p",[t._v("認証情報を保存しておくストレージの種類。")]),t._v(" "),n("ul",[n("li",[t._v("in-memory")]),t._v(" "),n("li",[t._v("Database")]),t._v(" "),n("li",[t._v("LDAP")])]),t._v(" "),n("h3",{attrs:{id:"認可"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#認可","aria-hidden":"true"}},[t._v("#")]),t._v(" 認可")]),t._v(" "),n("p",[t._v("認可は認証に依存している。"),n("br"),t._v("\nユーザが必要な権限を持っているかどうか決めること、それが認可。")]),t._v(" "),n("p",[t._v("認可は"),n("code",[t._v("Role")]),t._v("（"),n("code",[t._v("ADMIN")]),t._v(", "),n("code",[t._v("USER")]),t._v(", "),n("code",[t._v("GUEST")]),t._v("とか）と呼ばれることが多いので覚えておくこと。")]),t._v(" "),n("h2",{attrs:{id:"spring-securityに期待すること"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#spring-securityに期待すること","aria-hidden":"true"}},[t._v("#")]),t._v(" Spring Securityに期待すること")]),t._v(" "),n("h3",{attrs:{id:"portable"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#portable","aria-hidden":"true"}},[t._v("#")]),t._v(" Portable")]),t._v(" "),n("ul",[n("li",[t._v("サーバのセキュリティ設定をアプリケーション内で完結してほしい。")])]),t._v(" "),n("p",[t._v("サーバ上で設定すると、環境が変わる（サーバ更新）ごとに変更を加えないといけない。")]),t._v(" "),n("p",[t._v("Spring Bootなら、Tomcatサーバが組み込まれているのでアプリケーション内でセキュリティの設定を完結できる。")]),t._v(" "),n("h3",{attrs:{id:"separation-of-concerns"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#separation-of-concerns","aria-hidden":"true"}},[t._v("#")]),t._v(" Separation of Concerns")]),t._v(" "),n("ul",[n("li",[t._v("セキュリティの設定（付加的な処理）をビジネスロジックと分離したい。")]),t._v(" "),n("li",[t._v("認証と認可も分離したい。")])]),t._v(" "),n("p",[t._v("認証はよく変わる（ユーザが追加・削除する、パスワードを変更など）。すると、認証と紐付いている認可の設定も同時に変更する必要が出てくる。")]),t._v(" "),n("p",[t._v("関心事の分離といえば、AOP。SpringではAOPでセキュリティの設定をビジネスロジックに組み込んでいる（セキュリティは横断的関心事の１つ）。")]),t._v(" "),n("h3",{attrs:{id:"flexibility"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#flexibility","aria-hidden":"true"}},[t._v("#")]),t._v(" Flexibility")]),t._v(" "),n("ul",[n("li",[t._v("いろんな認証方法をサポートしてほしい（BASIC, Cookies, Single-Sign-Onなど）。")]),t._v(" "),n("li",[t._v("いろんな認証情報を保存する手段もサポートしてほしい（RDBMS, LDAPなど）。")])]),t._v(" "),n("h3",{attrs:{id:"extensible"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#extensible","aria-hidden":"true"}},[t._v("#")]),t._v(" Extensible")]),t._v(" "),n("ul",[n("li",[t._v("セキュリティの設定をカスタマイズしやすくしてほしい。")])]),t._v(" "),n("h2",{attrs:{id:"spring-securityの外観"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#spring-securityの外観","aria-hidden":"true"}},[t._v("#")]),t._v(" Spring Securityの外観")]),t._v(" "),n("p",[n("img",{attrs:{src:s(153),alt:"C006_6_Spring_Security.png"}})]),t._v(" "),n("h3",{attrs:{id:"config-attribute"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#config-attribute","aria-hidden":"true"}},[t._v("#")]),t._v(" Config Attribute")]),t._v(" "),n("p",[t._v("特定のユーザしかアクセスできないようにする。")]),t._v(" "),n("h3",{attrs:{id:"security-interceptor"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#security-interceptor","aria-hidden":"true"}},[t._v("#")]),t._v(" Security Interceptor")]),t._v(" "),n("p",[t._v("リソースを保護している。アクセス可能かどうかAccessDicisionManagerに確認する。")]),t._v(" "),n("p",[t._v("認可が降りない場合は、Exceptionをはく。")]),t._v(" "),n("h2",{attrs:{id:"requestからdispatcherservletへ処理を渡すまで"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#requestからdispatcherservletへ処理を渡すまで","aria-hidden":"true"}},[t._v("#")]),t._v(" RequestからDispatcherServletへ処理を渡すまで")]),t._v(" "),n("p",[n("img",{attrs:{src:s(154),alt:"C007_6_Spring_Security.png"}})]),t._v(" "),n("h3",{attrs:{id:"フィルタプロキシ（filter-proxy）"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#フィルタプロキシ（filter-proxy）","aria-hidden":"true"}},[t._v("#")]),t._v(" フィルタプロキシ（Filter proxy）")]),t._v(" "),n("p",[t._v("Servletコンテナ内で管理されている"),n("code",[t._v("DelegatingFilterProxy")]),t._v("は自分と同じ名前のBeanIDを持つインスタンスへ処理を移譲するだけの存在。")]),t._v(" "),n("h3",{attrs:{id:"security-filter-chain"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#security-filter-chain","aria-hidden":"true"}},[t._v("#")]),t._v(" Security filter chain")]),t._v(" "),n("p",[n("code",[t._v("DelegatingFilterProxy")]),t._v("から処理を受けるのが"),n("code",[t._v("SpringSecurityFilterChain")]),t._v("。SpringApplicationContext内で管理されている。")]),t._v(" "),n("p",[n("code",[t._v("SpringSecurityFilterChain")]),t._v("を起点にして、複数のFilterに通していく（SpringのDIコンテナ内）。Responseを返す場合、Requestと逆の流れを行く。")]),t._v(" "),n("p",[t._v("こちらはSpring側での設定になるが、Spring Bootを使用する場合は設定不要。")]),t._v(" "),n("h2",{attrs:{id:"enablewebsecurity"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#enablewebsecurity","aria-hidden":"true"}},[t._v("#")]),t._v(" @EnableWebSecurity")]),t._v(" "),n("ul",[n("li",[t._v("Spring Securityの有効化に必要。Spring Bootでも必要なので注意。")]),t._v(" "),n("li",[t._v("@Configurationアノテーションは必要ない（すでにinterfaceで定義されている）。")])]),t._v(" "),n("div",{staticClass:"language-java extra-class"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{attrs:{class:"token annotation punctuation"}},[t._v("@Configuration")]),t._v("\n"),n("span",{attrs:{class:"token annotation punctuation"}},[t._v("@EnableWebSecurity")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),n("span",{attrs:{class:"token class-name"}},[t._v("SecurityConfig")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),n("span",{attrs:{class:"token class-name"}},[t._v("WebSecurityConfigurerAdapter")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{attrs:{class:"token annotation punctuation"}},[t._v("@Override")]),t._v("\n    "),n("span",{attrs:{class:"token keyword"}},[t._v("protected")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("configure")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("HttpSecurity http"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("throws")]),t._v(" Exception "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),n("span",{attrs:{class:"token annotation punctuation"}},[t._v("@Autowired")]),t._v("\n    "),n("span",{attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("configureGlobal")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("AuthenticationManagerBuilder auth"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("throws")]),t._v(" Exception "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("h2",{attrs:{id:"特定のユーザに対して認可を行う"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#特定のユーザに対して認可を行う","aria-hidden":"true"}},[t._v("#")]),t._v(" 特定のユーザに対して認可を行う")]),t._v(" "),n("p",[t._v("特定のURLに対して、認可（アクセス権）を定義する。"),n("br"),t._v("\n以下の例では、"),n("code",[t._v("/admin")]),t._v("以下のファイルに対して"),n("code",[t._v("ADMIN")]),t._v("権限（Role）を持つユーザがアクセスできる。")]),t._v(" "),n("div",{staticClass:"language-java extra-class"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{attrs:{class:"token keyword"}},[t._v("protected")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("configure")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("HttpSecurity http"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("throws")]),t._v(" Exception "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    http"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("authorizeRequests")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("antMatchers")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"/admin/**"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("hasRole")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"ADMIN"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    …\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[n("code",[t._v("antMatchers")]),t._v("のURLパターンで使えるワイルドカードの意味は以下の通り。")]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",[t._v("URLパターン")]),t._v(" "),n("th",[t._v("説明")])])]),t._v(" "),n("tbody",[n("tr",[n("td",[t._v("/admin/*")]),t._v(" "),n("td",[t._v("/admin/xxxのみ")])]),t._v(" "),n("tr",[n("td",[t._v("/admin/**")]),t._v(" "),n("td",[t._v("/admin, /admin/xxx, /admin/xxx/yyy など")])])])]),t._v(" "),n("h3",{attrs:{id:"antmatchersとmvcmatchersについて"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#antmatchersとmvcmatchersについて","aria-hidden":"true"}},[t._v("#")]),t._v(" antMatchersとmvcMatchersについて")]),t._v(" "),n("ul",[n("li",[t._v("mvcMatchersのほうが新しいAPIで、よりセキュア。")]),t._v(" "),n("li",[t._v("mvcMatchersのマッチングルールは、"),n("code",[t._v("@RequestMapping")]),t._v("アノテーションと同じ（Suffixは任意でOK）。")])]),t._v(" "),n("div",{staticClass:"language-java extra-class"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[t._v("http"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("authorizeRequests")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{attrs:{class:"token comment"}},[t._v("// Only matches /admin")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("antMatchers")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"/admin"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("hasRole")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"ADMIN"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{attrs:{class:"token comment"}},[t._v("// Matches /admin, /admin/, /admin.html, /admin.xxx")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("mvcMatchers")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"/admin"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("hasRole")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"ADMIN"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),n("h3",{attrs:{id:"複数の設定をする場合"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#複数の設定をする場合","aria-hidden":"true"}},[t._v("#")]),t._v(" 複数の設定をする場合")]),t._v(" "),n("p",[t._v("メソッドチェーンでつなげて設定する。")]),t._v(" "),n("div",{staticClass:"language-java extra-class"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{attrs:{class:"token keyword"}},[t._v("protected")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("configure")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("HttpSecurity http"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("throws")]),t._v(" Exception "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    http\n      "),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("authorizeRequests")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("mvcMatchers")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"/signup"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v('"/about"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("permitAll")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("mvcMatchers")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"/accounts/edit*"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("hasRole")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"ADMIN"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("mvcMatchers")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"/accounts/**"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("hasAnyRole")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"USER"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v('"ADMIN"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("anyRequest")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("authenticated")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("以下にRoleの指定の仕方についてまとめた。")]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",[t._v("Roleパターン")]),t._v(" "),n("th",[t._v("説明")])])]),t._v(" "),n("tbody",[n("tr",[n("td",[t._v("permitAll")]),t._v(" "),n("td",[t._v("すべてのユーザを認可")])]),t._v(" "),n("tr",[n("td",[t._v("hasRole")]),t._v(" "),n("td",[t._v("１つのRoleを認可")])]),t._v(" "),n("tr",[n("td",[t._v("hasAnyRole")]),t._v(" "),n("td",[t._v("複数のRoleを認可")])])])]),t._v(" "),n("p",[n("code",[t._v(".anyRequest().authenticated()")]),t._v("を最後につける。全てのURLリクエストは認証されているユーザーしかアクセスできないという意味。")]),t._v(" "),n("p",[t._v("これを設定しておくことで、セキュリティの設定漏れによってアクセスできてしまうファイルがないようにする。")]),t._v(" "),n("h2",{attrs:{id:"ログイン・ログアウトのセキュリティ設定"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#ログイン・ログアウトのセキュリティ設定","aria-hidden":"true"}},[t._v("#")]),t._v(" ログイン・ログアウトのセキュリティ設定")]),t._v(" "),n("div",{staticClass:"language-java extra-class"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{attrs:{class:"token keyword"}},[t._v("protected")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("configure")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("HttpSecurity http"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("throws")]),t._v(" Exception "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    http\n        "),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("authorizeRequests")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("mvcMatchers")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"/admin/**"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("hasRole")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"ADMIN"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n        "),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("and")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token comment"}},[t._v("// method chaining!")]),t._v("\n\n        "),n("span",{attrs:{class:"token operator"}},[t._v("/")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v(" ログイン設定\n        "),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("formLogin")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("/")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v(" setup form"),n("span",{attrs:{class:"token operator"}},[t._v("-")]),t._v("based authentication\n        "),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("loginPage")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"/login"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("/")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v(" URL to use when login is needed\n        "),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("permitAll")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("/")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v(" any user can access\n        "),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("and")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("/")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v(" method chaining"),n("span",{attrs:{class:"token operator"}},[t._v("!")]),t._v("\n\n        "),n("span",{attrs:{class:"token operator"}},[t._v("/")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v(" ログアウト設定\n        "),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("logout")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("/")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v(" configure logout\n        "),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("logoutSuccessUrl")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"/home"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("/")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v(" go here after successful logout\n        "),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("permitAll")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("/")]),n("span",{attrs:{class:"token operator"}},[t._v("/")]),t._v(" any user can access\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("上記の"),n("code",[t._v("mvcMatchers")]),t._v("に一致する"),n("code",[t._v("/login")]),t._v("をFORMタグのaction属性に指定したHTMLファイル。")]),t._v(" "),n("div",{staticClass:"language-html extra-class"},[n("pre",{pre:!0,attrs:{class:"language-html"}},[n("code",[n("span",{attrs:{class:"token tag"}},[n("span",{attrs:{class:"token tag"}},[n("span",{attrs:{class:"token punctuation"}},[t._v("<")]),t._v("form")]),t._v(" "),n("span",{attrs:{class:"token attr-name"}},[t._v("action")]),n("span",{attrs:{class:"token attr-value"}},[n("span",{attrs:{class:"token punctuation"}},[t._v("=")]),t._v("“/login”")]),t._v(" "),n("span",{attrs:{class:"token attr-name"}},[t._v("method")]),n("span",{attrs:{class:"token attr-value"}},[n("span",{attrs:{class:"token punctuation"}},[t._v("=")]),t._v("“POST”")]),n("span",{attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),n("span",{attrs:{class:"token tag"}},[n("span",{attrs:{class:"token tag"}},[n("span",{attrs:{class:"token punctuation"}},[t._v("<")]),t._v("input")]),t._v(" "),n("span",{attrs:{class:"token attr-name"}},[t._v("type")]),n("span",{attrs:{class:"token attr-value"}},[n("span",{attrs:{class:"token punctuation"}},[t._v("=")]),t._v("“text”")]),t._v(" "),n("span",{attrs:{class:"token attr-name"}},[t._v("name")]),n("span",{attrs:{class:"token attr-value"}},[n("span",{attrs:{class:"token punctuation"}},[t._v("=")]),t._v("“username”/")]),n("span",{attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),n("span",{attrs:{class:"token tag"}},[n("span",{attrs:{class:"token tag"}},[n("span",{attrs:{class:"token punctuation"}},[t._v("<")]),t._v("br")]),n("span",{attrs:{class:"token punctuation"}},[t._v("/>")])]),t._v("\n    "),n("span",{attrs:{class:"token tag"}},[n("span",{attrs:{class:"token tag"}},[n("span",{attrs:{class:"token punctuation"}},[t._v("<")]),t._v("input")]),t._v(" "),n("span",{attrs:{class:"token attr-name"}},[t._v("type")]),n("span",{attrs:{class:"token attr-value"}},[n("span",{attrs:{class:"token punctuation"}},[t._v("=")]),t._v("“password”")]),t._v(" "),n("span",{attrs:{class:"token attr-name"}},[t._v("name")]),n("span",{attrs:{class:"token attr-value"}},[n("span",{attrs:{class:"token punctuation"}},[t._v("=")]),t._v("“password”/")]),n("span",{attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),n("span",{attrs:{class:"token tag"}},[n("span",{attrs:{class:"token tag"}},[n("span",{attrs:{class:"token punctuation"}},[t._v("<")]),t._v("br")]),n("span",{attrs:{class:"token punctuation"}},[t._v("/>")])]),t._v("\n    "),n("span",{attrs:{class:"token tag"}},[n("span",{attrs:{class:"token tag"}},[n("span",{attrs:{class:"token punctuation"}},[t._v("<")]),t._v("input")]),t._v(" "),n("span",{attrs:{class:"token attr-name"}},[t._v("type")]),n("span",{attrs:{class:"token attr-value"}},[n("span",{attrs:{class:"token punctuation"}},[t._v("=")]),t._v("“submit”")]),t._v(" "),n("span",{attrs:{class:"token attr-name"}},[t._v("name")]),n("span",{attrs:{class:"token attr-value"}},[n("span",{attrs:{class:"token punctuation"}},[t._v("=")]),t._v("“submit”")]),t._v(" "),n("span",{attrs:{class:"token attr-name"}},[t._v("value")]),n("span",{attrs:{class:"token attr-value"}},[n("span",{attrs:{class:"token punctuation"}},[t._v("=")]),t._v("“LOGIN”/")]),n("span",{attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),n("span",{attrs:{class:"token tag"}},[n("span",{attrs:{class:"token tag"}},[n("span",{attrs:{class:"token punctuation"}},[t._v("</")]),t._v("form")]),n("span",{attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])]),n("h3",{attrs:{id:"ログイン設定"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#ログイン設定","aria-hidden":"true"}},[t._v("#")]),t._v(" ログイン設定")]),t._v(" "),n("p",[t._v("ログインページとRoleの設定を行う。")]),t._v(" "),n("h3",{attrs:{id:"ログアウト設定"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#ログアウト設定","aria-hidden":"true"}},[t._v("#")]),t._v(" ログアウト設定")]),t._v(" "),n("p",[t._v("ログアウト後に遷移するページとRoleの設定を行う。")]),t._v(" "),n("p",[n("code",[t._v("and()")]),t._v("で設定同士をメソッドチェーンでつなげることができる。")]),t._v(" "),n("h2",{attrs:{id:"セキュリティ対象外に設定する"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#セキュリティ対象外に設定する","aria-hidden":"true"}},[t._v("#")]),t._v(" セキュリティ対象外に設定する")]),t._v(" "),n("p",[t._v("CSSファイルやJavascriptファイル、Imageファイルなどどのユーザでもアクセスできるファイルは、以下の例のようにセキュリティ対象外に設定する。")]),t._v(" "),n("div",{staticClass:"language-java extra-class"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{attrs:{class:"token keyword"}},[t._v("protected")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("configure")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("WebSecurity web"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("throws")]),t._v(" Exception "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    web"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("ignoring")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("mvcMatchers")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"/css/**"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v('"/images/**"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v('"/javascript/**"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[n("code",[t._v("ignoring()")]),t._v("を使って、マッチングするフォルダ内に存在するファイルをセキュリティ対象外に設定することができる。")]),t._v(" "),n("h2",{attrs:{id:"in-memoryでのユーザ情報設定（テスト用）"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#in-memoryでのユーザ情報設定（テスト用）","aria-hidden":"true"}},[t._v("#")]),t._v(" In-Memoryでのユーザ情報設定（テスト用）")]),t._v(" "),n("div",{staticClass:"language-java extra-class"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{attrs:{class:"token annotation punctuation"}},[t._v("@Autowired")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("configureGlobal")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("AuthenticationManagerBuilder auth"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("throws")]),t._v(" Exception "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    auth\n        "),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("inMemoryAuthentication")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("withUser")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"hughie"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("password")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"hughie"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("roles")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"GENERAL"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("and")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("withUser")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"dewey"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("password")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"dewey"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("roles")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"ADMIN"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("and")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("withUser")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"louie"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("password")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"louie"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("roles")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"SUPPORT"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("h2",{attrs:{id:"dbからのユーザ情報取得"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#dbからのユーザ情報取得","aria-hidden":"true"}},[t._v("#")]),t._v(" DBからのユーザ情報取得")]),t._v(" "),n("p",[t._v("DataSourceのインスタンスをコンストラクタでインジェクション。")]),t._v(" "),n("div",{staticClass:"language-java extra-class"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{attrs:{class:"token keyword"}},[t._v("private")]),t._v(" DataSource dataSource"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{attrs:{class:"token annotation punctuation"}},[t._v("@Autowired")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("setDataSource")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("DataSource dataSource"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("throws")]),t._v(" Exception "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{attrs:{class:"token keyword"}},[t._v("this")]),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dataSource "),n("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" dataSource"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),n("span",{attrs:{class:"token annotation punctuation"}},[t._v("@Autowired")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("configureGlobal")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("AuthenticationManagerBuilder auth"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("throws")]),t._v(" Exception "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    auth"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("jdbcAuthentication")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("dataSource")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dataSource"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("h2",{attrs:{id:"パスワードのハッシュ化"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#パスワードのハッシュ化","aria-hidden":"true"}},[t._v("#")]),t._v(" パスワードのハッシュ化")]),t._v(" "),n("p",[t._v("Spring Securityではパスワードのハッシュ化をサポートしている。")]),t._v(" "),n("ul",[n("li",[t._v("sha256, bcryptなど（sha256は脆弱性があることがわかっているので、bcrypt推奨）")])]),t._v(" "),n("p",[t._v("以下に、bcryptでハッシュ化する例を示した。")]),t._v(" "),n("div",{staticClass:"language-java extra-class"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[t._v("auth"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("inMemoryAuthentication")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("passwordEncoder")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{attrs:{class:"token class-name"}},[t._v("BCryptPasswordEncoder")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token number"}},[t._v("12")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),n("p",[t._v("引数の"),n("code",[t._v("12")]),t._v("は、2の12乗ハッシュ化の処理を繰り返すという意味。"),n("br"),t._v("\n数字を大きくすれば、よりセキュアになるがパフォーマンスに影響するので注意。")]),t._v(" "),n("p",[t._v("ハッシュ化したパスワードをDBなどに保存する。"),n("br"),t._v("\n以下では、In-Memoryでパスワードを保存したときの例を示す。")]),t._v(" "),n("div",{staticClass:"language-java extra-class"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[t._v("auth"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("inMemoryAuthentication")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("withUser")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"hughie"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("password")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"$2a$10$aMxNkanIJ...Ha.h5NKknelEuylt87PNlicYpI1y.IG0C."')]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("roles")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"GENERAL"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),n("h2",{attrs:{id:"profileを使って開発用と本番用でセキュリティ設定を変更する"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#profileを使って開発用と本番用でセキュリティ設定を変更する","aria-hidden":"true"}},[t._v("#")]),t._v(" @Profileを使って開発用と本番用でセキュリティ設定を変更する")]),t._v(" "),n("p",[n("code",[t._v("@Profile")]),t._v("アノテーションを用いて、開発用・テスト系・本番系などでログイン情報の参照先を変えることができる。")]),t._v(" "),n("p",[t._v("以下に設定を示す。")]),t._v(" "),n("div",{staticClass:"language-java extra-class"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),n("span",{attrs:{class:"token class-name"}},[t._v("SecurityBaseConfig")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),n("span",{attrs:{class:"token class-name"}},[t._v("WebSecurityConfigurerAdapter")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n    "),n("span",{attrs:{class:"token keyword"}},[t._v("protected")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("configure")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("HttpSecurity http"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("throws")]),t._v(" Exception "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        http"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("authorizeRequests")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("mvcMatchers")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"/resources/**"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("permitAll")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("開発系用。")]),t._v(" "),n("div",{staticClass:"language-java extra-class"},[n("div",{staticClass:"highlight-lines"},[n("br"),n("br"),n("div",{staticClass:"highlighted"},[t._v(" ")]),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br")]),n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{attrs:{class:"token annotation punctuation"}},[t._v("@Configuration")]),t._v("\n"),n("span",{attrs:{class:"token annotation punctuation"}},[t._v("@EnableWebSecurity")]),t._v("\n"),n("span",{attrs:{class:"token annotation punctuation"}},[t._v("@Profile")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"development"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),n("span",{attrs:{class:"token class-name"}},[t._v("SecurityDevConfig")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),n("span",{attrs:{class:"token class-name"}},[t._v("SecurityBaseConfig")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n    "),n("span",{attrs:{class:"token annotation punctuation"}},[t._v("@Autowired")]),t._v("\n    "),n("span",{attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("configureGlobal")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("AuthenticationManagerBuilder auth"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("throws")]),t._v(" Exception "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        auth"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("inMemoryAuthentication")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n            "),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("withUser")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"hughie"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("password")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"hughie"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("roles")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"GENERAL"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("テスト系・本番系用。")]),t._v(" "),n("div",{staticClass:"language-java extra-class"},[n("div",{staticClass:"highlight-lines"},[n("br"),n("br"),n("div",{staticClass:"highlighted"},[t._v(" ")]),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br"),n("br")]),n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{attrs:{class:"token annotation punctuation"}},[t._v("@Configuration")]),t._v("\n"),n("span",{attrs:{class:"token annotation punctuation"}},[t._v("@EnableWebSecurity")]),t._v("\n"),n("span",{attrs:{class:"token annotation punctuation"}},[t._v("@Profile")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v('"jdbc"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),n("span",{attrs:{class:"token class-name"}},[t._v("SecurityJdbcConfig")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),n("span",{attrs:{class:"token class-name"}},[t._v("SecurityBaseConfig")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n    "),n("span",{attrs:{class:"token annotation punctuation"}},[t._v("@Autowired")]),t._v("\n    "),n("span",{attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),n("span",{attrs:{class:"token function"}},[t._v("configureGlobal")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("AuthenticationManagerBuilder auth"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("throws")]),t._v(" Exception "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        auth"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("jdbcAuthentication")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token function"}},[t._v("dataSource")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dataSource"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("以上までがディレクトリの階層・ファイル単位でのセキュリティの設定方法。")]),t._v(" "),n("h2",{attrs:{id:"メソッド単位でのセキュリティ設定"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#メソッド単位でのセキュリティ設定","aria-hidden":"true"}},[t._v("#")]),t._v(" メソッド単位でのセキュリティ設定")]),t._v(" "),n("p",[t._v("Service Layerであるビジネスロジックにもセキュリティを施す。理由としては、上記までのセキュリティ対策にヌケモレがあったときにカバーできるようにするため。")]),t._v(" "),n("p",[t._v("メソッドごとに権限が付与されており、特定のRoleしか実行できないメソッドを用意することができる（マスタの設定を行うメソッドは、管理者権限を持つユーザしか使えなくするとか）。")]),t._v(" "),n("p",[t._v("Spring AOP Proxyを利用して、セキュリティ設定をインジェクションする。"),n("br"),t._v("\n認可が降りない場合は、"),n("code",[t._v("AccessDeniedException")]),t._v("をはく。")]),t._v(" "),n("p",[n("img",{attrs:{src:s(155),alt:"C008_6_Spring_Security.png"}})]),t._v(" "),n("h2",{attrs:{id:"メソッドの開始前・後に実行する権限設定"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#メソッドの開始前・後に実行する権限設定","aria-hidden":"true"}},[t._v("#")]),t._v(" メソッドの開始前・後に実行する権限設定")]),t._v(" "),n("p",[t._v("メソッドの開始前（"),n("code",[t._v("@PreAuthorize")]),t._v("）でそのメソッドを実行できる権限をRoleが持っているかどうか確認する事ができる。また、メソッドの後処理（"),n("code",[t._v("@PostAuthorize")]),t._v("）でメソッドの戻り値と比較して、OKかどうか判断できる。")]),t._v(" "),n("p",[t._v("いかに例を示す。"),n("br"),t._v("\nまず、"),n("code",[t._v("@EnableGlobalMethodSecurity")]),t._v("アノテーションをつけて、設定を有効化する必要がある。")]),t._v(" "),n("div",{staticClass:"language-java extra-class"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{attrs:{class:"token annotation punctuation"}},[t._v("@EnableGlobalMethodSecurity")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("prePostEnabled"),n("span",{attrs:{class:"token operator"}},[t._v("=")]),n("span",{attrs:{class:"token boolean"}},[t._v("true")]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),n("div",{staticClass:"language-java extra-class"},[n("pre",{pre:!0,attrs:{class:"language-java"}},[n("code",[n("span",{attrs:{class:"token keyword"}},[t._v("import")]),t._v(" org"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("springframework"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("security"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("annotation"),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("PreAuthorize"),n("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),n("span",{attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),n("span",{attrs:{class:"token class-name"}},[t._v("ItemManager")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n    "),n("span",{attrs:{class:"token comment"}},[t._v("// Members may only find their own order items")]),t._v("\n    "),n("span",{attrs:{class:"token annotation punctuation"}},[t._v("@PreAuthorize")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{attrs:{class:"token string"}},[t._v("\"hasRole('MEMBER') && \"")]),t._v(" "),n("span",{attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),n("span",{attrs:{class:"token string"}},[t._v('"#order.owner.id == principal.user.id"')]),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),n("span",{attrs:{class:"token keyword"}},[t._v("public")]),t._v(" Item "),n("span",{attrs:{class:"token function"}},[t._v("findItem")]),n("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Order order"),n("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{attrs:{class:"token keyword"}},[t._v("long")]),t._v(" itemNumber"),n("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n    "),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[n("code",[t._v("@Secured")]),t._v("アノテーションもあるが、すでに古いので使わないこと。")]),t._v(" "),n("h2",{attrs:{id:"wip-積み残し課題"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#wip-積み残し課題","aria-hidden":"true"}},[t._v("#")]),t._v(" [WIP] 積み残し課題")]),t._v(" "),n("ul",[n("li",[t._v("What is a security context?")]),t._v(" "),n("li",[t._v("Why do you need the intercept-url?")]),t._v(" "),n("li",[t._v("In which order do you have to write multiple intercept-url's?")]),t._v(" "),n("li",[t._v("Why is an mvcMatcher more secure than an antMatcher?")]),t._v(" "),n("li",[t._v("Why do you need method security? What type of object is typically secured at the method level (think of its purpose not its Java type).")]),t._v(" "),n("li",[t._v("What does Spring’s @Secured do?")]),t._v(" "),n("li",[t._v("How are these annotations implemented?")]),t._v(" "),n("li",[t._v("In which security annotation are you allowed to use SpEL?")]),t._v(" "),n("li",[t._v("Is it enough to hide sections of my output (e.g. JSP-Page or Mustache template)?")]),t._v(" "),n("li",[t._v("Spring security offers a security tag library for JSP, would you recognize it if you saw it in an example?")])])])}],o=s(0),e=Object(o.a)({},function(){this.$createElement;this._self._c;return this._m(0)},n,!1,null,null,null);e.options.__file="6_security.md";a.default=e.exports}}]);